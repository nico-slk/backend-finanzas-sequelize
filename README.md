# backend-finanzas-sequelize

**Overview**

- **Description:** A small financial backend that manages `ventas` (sales) and `gastos` (expenses) using PostgreSQL and Sequelize.
- **Architecture note:** Authentication (user login and token generation) is handled by a separate microservice; this service only validates tokens and roles.

**Prerequisites**

- Node.js (>= 16 recommended)
- PostgreSQL database
- Environment variables set (see **Configuration**)

**Configuration**

- Provide database and auth configuration via environment variables (example `.env`):
  - `PORT` — HTTP port (defaults to 3000 in code)
  - `DB_HOST`, `DB_USER`, `DB_PORT`, `DB_NAME`, `DB_PASSWORD` — Postgres connection
  - `AUTH_JWT_SECRET` — JWT secret used to validate tokens generated by the auth microservice

**Install & Run**

- Install dependencies:

```bash
npm install
```

- Build & start:

```bash
npm start
```

- Development (auto-restart):

```bash
npm run dev
```

**Project style**

- This codebase uses TypeScript ES modules and functional/module exports for controllers and services (not class-based controllers/services). Some utility classes (for example the server class) may exist, but endpoints/controllers are implemented as module exports.

**Database bootstrap**

- When the server starts it calls the script `script.sql` (project root) via `src/db/runScript.ts`. That SQL file is executed after Sequelize sync to populate initial data.

**File import for JSON data**

- There is an endpoint to import JSON data (see endpoints below). A sample JSON file is provided at `test.json` in the project root to exercise the import endpoint.

**API Endpoints**

All endpoints are mounted under the `/api` prefix. Below each path lists required authentication/role and the request shape.

- **Ventas (Sales)** — base path: `/api/venta`

  - GET `/api/venta/` : List ventas. Optional query `?filtro=` accepts `dia|semana|mes|anio` to filter by date range. (Public — no token required)
  - GET `/api/venta/:id` : Get a venta by `id`. (Public)
  - GET `/api/venta/deleted` : List soft-deleted ventas. (Requires token)
  - POST `/api/venta/` : Create a venta. Body (JSON): `{ categoria, monto, descripcion?, fecha? }`. (Requires token)
  - PUT `/api/venta/:id` : Update a venta. Body: partial vente fields. (Requires token)
  - DELETE `/api/venta/:id` : Soft-delete a venta. (Requires token AND `admin` role)
  - PUT `/api/venta/restore/:id` : Restore a soft-deleted venta. (Requires token AND `admin` role)

- **Gastos (Expenses)** — base path: `/api/gasto`

  - GET `/api/gasto/` : List gastos. Optional query `?filtro=` accepts `dia|semana|mes|anio`. (Public)
  - GET `/api/gasto/:id` : Get a gasto by `id`. (Public)
  - GET `/api/gasto/deleted` : List soft-deleted gastos. (Requires token)
  - POST `/api/gasto/` : Create a gasto. Body (JSON): `{ categoria, monto, descripcion?, fecha? }`. (Requires token)
  - PUT `/api/gasto/:id` : Update a gasto. (Requires token)
  - DELETE `/api/gasto/:id` : Soft-delete a gasto. (Requires token AND `admin` role)
  - PUT `/api/gasto/restore/:id` : Restore a soft-deleted gasto. (Requires token AND `admin` role)

- **Dashboard / Line Chart** — base path: `/api/dashboard`

  - GET `/api/dashboard/line-chart` : Returns aggregated daily totals for ventas and gastos suitable for charting. (Public)

- **JSON Import** — base path: `/api/import-json`
  - POST `/api/import-json/` : Accepts a multipart/form-data request with a single file field named `archivo` containing a JSON file. Requires token AND `admin` role.
    - Multer settings: file stored under `uploads/`, max file size 5MB, field name: `archivo`.
    - The import service expects top-level keys `{ ventas?: [], gastos?: [] }`. Each array item should match the model fields: `fecha` (ISO string), `categoria`, `monto` (number or numeric string), `descripcion`.

**Authentication & Authorization**

- This service expects an Authorization header set by the client using tokens issued by the external auth microservice:

```
Authorization: Bearer <token>
```

- Token validation middleware: `src/lodash/valid-jwt.ts` — checks `Authorization` header, verifies JWT using `AUTH_JWT_SECRET` from env.
- Role middleware: `src/lodash/rolChecker.ts` — after token verification it expects `(req as any).user` to contain user info and checks `user.rol === 'admin'` for admin-protected endpoints.

**Models / Validation**

- Models are defined with Sequelize in `src/models` (no runtime schema validation library is used). Important fields:
  - `venta` and `gasto` models: `id` (UUID), `fecha` (DATE, default now), `categoria` (string, required), `monto` (decimal, required), `descripcion` (optional). Both models use paranoid deletes (soft delete).

**Upload & Import behavior**

- The import endpoint parses the uploaded file, bulk-creates records inside a transaction, then deletes the uploaded file from disk. If an error occurs the transaction is rolled back and the file is removed.

**Files of interest**

- `src/routes.ts` — API routes registration
- `src/router/*.route.ts` — route definitions
- `src/controller/*` — controllers (module exports)
- `src/services/*` — business logic and DB access
- `src/lodash/valid-jwt.ts` and `src/lodash/rolChecker.ts` — auth middlewares
- `script.sql` — SQL script executed at startup to populate DB
- `test.json` — sample JSON to test the import endpoint (project root)

**Sample `test.json`**

- A sample JSON file is included in the project root as `test.json`. It contains `ventas` and `gastos` arrays suitable for the `/api/import-json` endpoint. See `test.json` file.

**Notes & troubleshooting**

- Ensure the auth microservice issues JWTs signed with the same `AUTH_JWT_SECRET` value used by this service, otherwise token validation will fail.
- The import endpoint expects the uploaded file field to be named `archivo` (Spanish: "file").

If you want, I can also add a short example `curl` and Postman collection showing how to call the protected import endpoint.

**Examples: Requests, Tokens & Responses**

- **Token (JWT) — example decoded payload**

```json
{
  "id": "11111111-2222-3333-4444-555555555555",
  "email": "admin@example.com",
  "rol": "admin",
  "iat": 1700000000
}
```

- Use the token in requests as:

```
Authorization: Bearer <JWT_TOKEN>
```

- **Create `venta` — request body (JSON)**

```json
{
  "categoria": "Servicios",
  "monto": 1500.5,
  "descripcion": "Consultoría Desarrollo Web",
  "fecha": "2026-01-10T10:00:00.000Z"
}
```

- **Successful `POST /api/venta/` response (201)**

```json
{
  "id": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
  "categoria": "Servicios",
  "monto": "1500.50",
  "descripcion": "Consultoría Desarrollo Web",
  "fecha": "2026-01-10T10:00:00.000Z",
  "createdAt": "2026-01-13T12:00:00.000Z",
  "updatedAt": "2026-01-13T12:00:00.000Z"
}
```

- **Common error responses**
  - `401` No `Authorization` header or token missing:

```json
{ "msg": "No token provided" }
```

- `403` Token invalid or verification failed:

```json
{ "msg": "Failed to authenticate token", "error": "jwt malformed" }
```

- `403` Role denied when admin required:

```json
{ "msg": "Acceso denegado: El rol 'user' no tiene permisos para esta acción" }
```

- **Successful import response**

```json
{
  "message": "Importación completada con éxito",
  "detalle": { "ventas": 4, "gastos": 3 }
}
```

- **More `curl` examples: create / update / delete**

- Create `gasto` (requires token):

```bash
curl -X POST "http://localhost:3000/api/gasto/" \
  -H "Authorization: Bearer ADMIN_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"categoria":"Oficina","monto":200.0,"descripcion":"Suministros de papelería","fecha":"2026-01-11T12:00:00.000Z"}'
```

- Sample successful `POST /api/gasto/` response (201):

```json
{
  "id": "bbbbbbbb-cccc-dddd-eeee-ffffffffffff",
  "categoria": "Oficina",
  "monto": "200.00",
  "descripcion": "Suministros de papelería",
  "fecha": "2026-01-11T12:00:00.000Z",
  "createdAt": "2026-01-13T12:00:00.000Z",
  "updatedAt": "2026-01-13T12:00:00.000Z"
}
```

- Update a `venta` (requires token):

```bash
curl -X PUT "http://localhost:3000/api/venta/<VENTA_ID>" \
  -H "Authorization: Bearer ADMIN_OR_USER_JWT" \
  -H "Content-Type: application/json" \
  -d '{"monto":1600.0, "descripcion":"Ajuste de monto"}'
```

- Sample successful `PUT /api/venta/:id` response (200):

```json
{
  "id": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
  "categoria": "Servicios",
  "monto": "1600.00",
  "descripcion": "Ajuste de monto",
  "fecha": "2026-01-10T10:00:00.000Z",
  "createdAt": "2026-01-13T12:00:00.000Z",
  "updatedAt": "2026-01-13T12:05:00.000Z"
}
```

- Delete a `venta` (requires token + admin role):

```bash
curl -X DELETE "http://localhost:3000/api/venta/<VENTA_ID>" \
  -H "Authorization: Bearer ADMIN_JWT_TOKEN"
```

- Sample successful `DELETE /api/venta/:id` response (200):

```json
{ "message": "Venta eliminada correctamente." }
```
